THIS_DIR="$(git rev-parse --show-toplevel)"
SECRETS_DIR="${THIS_DIR}/.secrets"

type brew &>/dev/null || /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

# Utils
type kubectl &>/dev/null || brew install kubectl
type jq &>/dev/null || brew install jq

# mozilla/sops
type sops &>/dev/null || brew install sops

sops -d "${SECRETS_DIR}/.envrc.enc.sh" > "${SECRETS_DIR}/.envrc.sh"

source "${SECRETS_DIR}/.envrc.sh"

export KUBECONFIG_ENC="${SECRETS_DIR}/kubeconfig.enc.yaml"
export KUBECONFIG="${SECRETS_DIR}/kubeconfig.yaml"

sops -d "${KUBECONFIG_ENC}" > "${KUBECONFIG}"

# SSH
ssh() {
	MY_IP=$(curl --silent https://api.ipify.org) && doctl compute firewall add-rules $(doctl compute firewall list --output=json | jq -r '.[].id') --inbound-rules "protocol:tcp,ports:22,address:${MY_IP}/32"

	/usr/bin/ssh $@

	MY_IP=$(curl --silent https://api.ipify.org) && doctl compute firewall remove-rules $(doctl compute firewall list --output=json | jq -r '.[].id') --inbound-rules "protocol:tcp,ports:22,address:${MY_IP}/32"
}